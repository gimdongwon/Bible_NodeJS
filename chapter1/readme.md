# Start Nodejs

## 정의

`Node.js는 Chrome V8 Javascript 엔진으로 빌드된 Javascript 런타임입니다.`

서버라는 말이 없는 이유는 Node가 서버만 실행할 수 있는 것은 아니기 때문이다. 이 책에서도 전반적으로 노드를 서버로 실행하는 방법을 다루지만 일부 장에서는 서버 외의 자바스크립트 프로그램을 실행하는 런타임으로서 사용하는 방법을 배울것이다.

## 서버

노드를 통해 다양한 JS 애플리케이션을 실행할 수 있지만 노드는 서버 애플리케이션을 실행하는데 제일 많이 사용한다.

그럼 서버란 무엇이며 어떤 역할을 할까? `서버는 네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램을 말한다.` 클라이언트란 요청을 보내는 주체로 브라우저일 수도 있고, 데스크톱 프로그램, 모바일 앱, 다른 서버로 요청을 보내는 서버일 수 도 있다. 서버는 요청에 대한 응답만 하는 것은 아니고 다른 서버에 요청을 보낼 수도 있다. 이때는 요청을 보낸 서버가 클라이언트 역할을 한다.

### JavaScript의 런타임

노드는 자바스크립트 런타임이다. `런타임은 특정 언어로 만든 프로그램들을 실행할 수 있는 환경을 뜻한다.` 따라서 노드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있다. 쉽게 말해 노드는 자바스크립트 실행기라고 봐도 무방하다.

기존에는 자바스크립트 프로그램을 웹 브라우저 위에서만 실행할 수 있었다. 브라우저는 자바스크립트 런타임을 내장하고 있으므로 자바스크립트 코드를 실행할 수 있다. 브라우저 외의 환경에서 자바스크립트를 실행하기 위한 여러 시도가 있었으나, 실행속도 때문에 큰 호응을 얻지 못했다.

하지만 2008년 구글이 V8엔진을 사용하여 크롬을 출시하자 이야기가 달라졌다. 문제였던 JS 엔진 속도가 매우 빨라졌고 오픈소스로 코드를 공개했다. 속도 문제가 해결되자 라이언 달은 2009년 V8 엔진 기반의 노드 프로젝트를 시작했다.

![node 구조](https://media.vlpt.us/post-images/doyuni/a7c98cb0-2df6-11ea-bfdf-c3d57317c0d1/-2020-01-03-3.58.11.png)

![Ryan Dahl](https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Ryan_Dahl.jpg/220px-Ryan_Dahl.jpg)

노드는 V8(오픈소스 자바스크립트 엔진)과 더불어 libuv라는 라이브러리를 사용한다.V8과 libuv는 C와 C++로 구현되어 있으며 여러분이 작성한 자바스크립트 코드는 노드가 알아서 V8과 libuv에 연결해준다.

libuv 라이브러리는 노드의 특성인 이벤트 기반, 논 블로킹 I/O 모델을 구현한다.

### 이벤트 기반

`이벤트 기반(event driven)이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 의미한다.` 이벤트로는 클릭이나 네트워크 요청 등이 있을 수 있다.

이벤트 기반 시스템에서는 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해야 한다. 이를 이벤트 리스너에 콜백 함수를 등록한다고 한다. 버튼을 클릭할 때 경고창을 띄우도록 설정하는 것을 예로 들어보겠다.

노드도 이벤트 기반 방시긍로 동작하므로, 이벤트가 발생하면 이벤트 리스너에 등록해둔 콜백 함수를 호출한다. 발생한 이벤트가 없거나 발생했던 이벤트를 다 처리하면, 노드는 다음 이벤트가 발생할 때가지 대기한다.

이벤트 기반 모델에서는 `이벤트 루프(evnet loop)`라는 개념이 등장한다. `여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백 함수를 호출할지를 이벤트 루프가 판단한다.`

노드는 자바스크립트 코드의 맨 위부터 한 줄씩 실행한다. 함수 호출 부분을 발견했다면 호출한 함수를 호출 스택에 넣는다. 여기서 호출스택을 그려보면 이해가 좋다.

anonymous 함수는 처음 실행 시의 전역 컨텍스트를 의미한다. 컨텍스트는 함수가 호출되었을 때 생성되는 환경을 의미한다. 자바스크립트 코드는 실행 시 기본적으로 전역 컨텍스트 안에서 돌아간다. 함수는 실행되는 동안 호출 스택에 머물어 있다가 실행이 완료되면 호출 스택에서 지워진다.

- **이벤트 루프** : 이벤트 발생 시 호출할 콜백 함수들을 관리하고 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당한다. 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 `루프(loop)`라고 한다.
- **백그라운드** : setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳이다. 자바스크립트가 아닌 다른 언어로 작성된 프로그램이라고 봐도 된다. 여러 작업이 동시에 실행될 수 있다. 여기선 Web APIs
- **테스트 큐(이벤트 큐)** : 이벤트 발생 후, 백그라운드에서는 테스트 큐로 타이머나 이벤트 리스너의 콜백 함수를 보낸다. 정해진 순서대로 콜백들이 줄을 서 있으므로 콜백 큐라고도 부른다. 콜백들은 보통 완료된 순서대로 줄을 서 있지만 특정한 경우에는 순서가 바뀌기도 한다.
- **Heap** : heap은 변수들을 저장하는 장소

  ![event que](https://user-images.githubusercontent.com/48500660/66096899-67941c80-e5d7-11e9-8f7c-175788e29327.png)

그림에서는 테스트 큐가 하나의 큐처럼 보이지만 실제로는 여러 개의 큐로 이루어져있다.

호출 스택에 함수들이 너무 많이 들어 있으면 3초가 지난 후에도 setTimeout 콜백 함수가 실행되지 않을 수 있다. 이벤트 루프는 호출 스택이 비어 있을 때만 테스트 큐에 있는 run 함수를 호출 스택으로 가져온다. 이것이 setTimeout의 시간이 정확하지 않을 수도 있는 이유이다.

### 논 블로킹 I/O

이벤트 루프를 잘 활용하면 오래 걸리는 작업을 효율적으로 처리할 수 있다. 작업에는 두 가지 종류가 있는데, 동시에 실행될 수 있는 작업과 동시에 실행될 수 없는 작업이 있습니다. 기본적으로 우리가 작성한 자바스크립트 코드는 동시에 실행될 수 없다. 하지만 자바스크립트 상에서 돌아가는 것이 아닌 I/O 작업 같은 것은 동시에 처리될 수 있다.

I/O는 입력(input)/출력(ouput)을 의미한다. 파일 시스템 접근이나 네트워크를 통한 요청 같은 작업이 I/O의 일종이다. 이러한 작업을 할 때 노드는 논 블로킹 방식으로 처리하는 방법을 제공한다. **논 블로킹** 이란 이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행함을 뜻한다. 반대로 블로킹은 이전 작업이 끝나야만 다음 작업을 수행하는 것을 의미한다.

(작업들이 전부 동시에 처리될 수 있는 작업이라면)블로킹 방식보다 논 블로킹 방식이 같은 작업을 더 짧은 시간에 처리할 수 있다. 노드는 I/O 작업을 백 그라운드로 넘겨 동시에 처리하곤 한다. 따라서 동시에 처리될 수 있는 작업들은 최대한 묶어서 백그라운드로 넘겨야 시간을 절약할 수 있다.

다만 코드가 전부 우리가 작성한 것이라면 소요시간은 짧아지지 않는다. 하지만 그렇다고 해서 의미가 없는 것은 아니다. 오래 걸리는 작업들을 처리하는 경우, 논 블로킹을 통해 순서를 바꿔주므로 간단한 작업들이 대기하는 상황을 막을 수 있다. 또한 **논블로킹과 동시가 같은 의미는 아니라는 것**을 알아둘 필요가 있다.

### 싱글 스레드

싱글 스레드는 스레드가 하나뿐이라는 것을 의미한다. 우리가 작성한 자바스크립트 코드가 동시에 실행될 수 없는 이유이기도 하다. 스레드를 이해하기 위해서는 프로세스부터 알아야 하는데 프로세스와 스레드의 차이는 다음과 같다.

- 프로세스는 운영체제에서 할당하는 작업의 단위이다. 노드나 웹 브라우저 같은 프로그램은 개별적인 프로세스이다. 프로세스 간에는 메모리 등의 자원을 공유하지 않는다.
- 스레드는 프로세스 내에서 실행되는 흐름의 단위이다. 프로세스는 스레드를 여러 개 생성해 여러 작업을 동시에 처리할 수 있다. 스레드들은 부모 프로세스의 자원을 공유한다. 같은 주소의 메모리에 접근 가능하므로 데이터를 공유할 수 있다.

> 프로세스는 라면을 끓이는 세션, 스레드는 파, 라면 등을 넣는 작업.

노드는 싱글 스레드라는 말을 들어보았을 테지만, 엄밀히 말하면 싱글 스레드로 동작하지는 않는다. 노드를 실행하면 프로세스 하나가 생성된다. 그 프로세스에서 스레드들을 생성하는데, 이때 내부적으로 스레드를 여러개 생성한다. 그중에서 우리가 직접 제어할 스레드는 하나이다. 그래서 노드가 싱글 스레드라고 여겨진다.

스레드는 작업을 처리하는 일손으로 표현하기도 하는데, 하나의 스레드만 직접 조작할 수 있으므로 일손이 하나인 셈이다. 요청이 많이 들어오면 한 번에 하나씩 요청을 처리한다. 블로킹이 심하게 일어나는 작업을 처리하지만 않는다면 하나의 스레드로 충분하다. 블로킹이 발생할 것 같은 경우는 논 블로킹 방법으로 처리한다.

> 노드가 싱글 스레드로 동작하지 않는 두가지 경우가 있는데, 하나는 스레드풀이고 다른 하나는 워커 스레드 이다.

## 서버로서의 노드
